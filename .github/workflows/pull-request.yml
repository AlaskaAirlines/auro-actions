on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        required: false
    inputs:
      component:
        description: 'Component name for demo deployment'
        required: true
        type: string
      is-monorepo:
        description: 'Is this a monorepo setup?'
        required: false
        type: boolean
        default: false
      cache-dirs:
        description: 'Directories to cache build artifacts'
        required: false
        type: string
        default: |
          ./dist
          ./demo
          ./node_modules
          ./custom-elements.json

permissions:
  id-token: write  # required for OIDC
  contents: write
  deployments: write
  issues: write
  pull-requests: write

jobs:
  build:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: AlaskaAirlines/auro-actions/.github/actions/build@dev
        with:
          os: ubuntu-latest
          node-version: ${{ matrix.node-version }}
          cache-dirs: ${{ inputs.cache-dirs }}
  test:
    if: github.event.action != 'closed'
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: AlaskaAirlines/auro-actions/.github/actions/test@dev
        with:
          os: ubuntu-latest
          node-version: ${{ matrix.node-version }}
          cache-dirs: ${{ inputs.cache-dirs }}
  release:
    needs: [build, test]
    runs-on: ubuntu-latest
    # Skip on PR close and on release branches
    if: github.event.action != 'closed' && !startsWith(github.ref, 'refs/heads/rc/')
    steps:
        - uses: actions/checkout@v4
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: 22
            registry-url: 'https://registry.npmjs.org'
        - name: Restore dist/demo directories to cache
          uses: actions/cache@v4
          id: build-ubuntu-latest-node-v22
          with:
            path: ${{ inputs.cache-dirs }}
            key: build-22-${{ github.run_id }}
        - name: Generate PR release version
          run: npx --ignore-scripts --package=@aurodesignsystem/auro-cli -- auro pr-release -p ${{ github.event.pull_request.number }}
        - name: Read package.json
          id: package
          uses: actions/github-script@v7
          with:
            script: |
              const fs = require('fs');
              const packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
              const prodName = packageJson.name.replace('-dev', '');
              core.setOutput('name', packageJson.name);
              core.setOutput('prodName', prodName);
              core.setOutput('version', packageJson.version);
              return packageJson;
            result-encoding: string
        - name: Upgrade NPM
          run: npm install -g npm@latest
        - name: Publish to NPM
          run: npm publish --tag latest --provenance
          env:
            NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        - name: Comment on PR
          uses: marocchino/sticky-pull-request-comment@v2
          with:
            header: release
            message: |
              ðŸš€ PR Release Published! `v${{ steps.package.outputs.version }}`

              To install:
              ```bash
              npm install ${{ steps.package.outputs.name }}@${{ steps.package.outputs.version }}
              ```

              Install via alias:
              ```bash
              npm install ${{ steps.package.outputs.prodName }}@npm:${{ steps.package.outputs.name }}@${{ steps.package.outputs.version }}
              ```

              [View on npmjs.com](https://www.npmjs.com/package/${{ steps.package.outputs.name }}/v/${{ steps.package.outputs.version }})
  preview:
    needs: [build, test]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: ${{ fromJson(inputs.component) }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Restore dist/demo directories to cache
        uses: actions/cache@v4
        id: build_cache
        with:
          path: ${{ inputs.cache-dirs }}
          key: build-22-${{ github.run_id }}
      - name: Set demo path
        id: demo_path
        run: |
          if [ "${{ inputs.is-monorepo }}" = "true" ]; then
            # For monorepo, deploy component demo
            echo "value=./components/${{ matrix.component }}/demo" >> $GITHUB_OUTPUT
          else
            # For single component, deploy demo directory
            echo "value=./demo" >> $GITHUB_OUTPUT
          fi
      - name: Deploy ${{ matrix.component }} preview
        uses: AlaskaAirlines/auro-actions/.github/actions/pr-preview@dev
        with:
          source-dir: ${{ steps.demo_path.outputs.value }}
          umbrella-dir: 'pr-preview/${{ matrix.component }}'
          github-token: ${{ secrets.GITHUB_TOKEN }}
